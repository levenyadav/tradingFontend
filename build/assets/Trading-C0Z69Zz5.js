import{j as e}from"./radix-D5295bUi.js";import{r as s}from"./charts-Dh6mNU2f.js";import{u as be,h as ye,w as f,L as z,T as ie,d as ce,I as se,i as Y,k as pe,l as ve,D as je,n as we,o as Ne,q as Se,X as ke,B as re,p as J,s as Ee,A as Ce,f as $}from"./index-CxMdxSJL.js";import"./vendor-DDxydHEc.js";function ae(n,c){const[m,v]=s.useState(n);return s.useEffect(()=>{const S=setTimeout(()=>v(n),c);return()=>clearTimeout(S)},[n,c]),m}function Pe({open:n,onOpenChange:c,symbol:m,bid:v,ask:S,initialDirection:g="buy",commissionPerLot:k=2.5,contractMultiplier:j=1e5,accountId:a,onConfirm:R}){const{selectedAccountId:o,accounts:L}=be(),[u,K]=s.useState("market"),[h,M]=s.useState(g),[p,D]=s.useState(!1),[b,V]=s.useState(.01),[F,I]=s.useState(void 0),[E,Q]=s.useState(!1),[A,Z]=s.useState(void 0),[T,_]=s.useState(void 0),[w,q]=s.useState(100),[U,W]=s.useState(a||null),[l,C]=s.useState(null),[H,r]=s.useState(null),[x,B]=s.useState(!1),[y,X]=s.useState(null),[G,oe]=s.useState(v),[ne,le]=s.useState(S),P=h==="buy"?ne:G,ee=ae(b,120),O=ae(F,120),{contractValue:de,marginRequired:me,estCommission:ue}=s.useMemo(()=>{const t=m.toUpperCase(),i=t.includes("BTC")||t.includes("ETH")||t.includes("BNB")||t.includes("SOL")||t.includes("ADA")||t.includes("XRP")||t.includes("DOGE")?1:j,N=P*ee*i,te=N/Math.max(1,w),fe=ee*k;return{contractValue:N,marginRequired:te,estCommission:fe}},[m,P,ee,w,k,j]),xe=async()=>{B(!0),X(null);try{const t={accountId:U||a||"",symbol:m,type:u,direction:h,volume:b,comment:"web"};if(u!=="market"&&typeof O=="number"&&(t.price=O),typeof A=="number"&&(t.stopLoss=A),typeof T=="number"&&(t.takeProfit=T),!t.accountId)throw new Error("No active account");const d=await Ee(t);R({type:u,direction:h,lotSize:b,entryPrice:u!=="market"?O:void 0,stopLoss:A,takeProfit:T,leverage:w}),c(!1)}catch(t){const d=t?.data?.details,i=Array.isArray(d)?d.map(N=>`${N.field}: ${N.message}`).join("; "):t?.message||"Order failed";X(i)}finally{B(!1)}},ge=b<.01||u!=="market"&&!O||x;s.useEffect(()=>{const t=window.visualViewport;if(!t)return;const d=()=>r(t.height);return d(),t.addEventListener("resize",d),()=>t.removeEventListener("resize",d)},[]),s.useEffect(()=>{M(g)},[g]),s.useEffect(()=>{const t=L&&L.length>0?L.find(d=>String(d._id)===String(o||a||U||""))||L[0]:void 0;if(t){W(t._id),C(t.accountNumber),typeof t.leverage=="number"&&q(t.leverage);return}(async()=>{try{const d=await ye("active"),i=d.find(N=>N._id===(o||a||U||""))||d[0];if(!i)return;W(i._id),C(i.accountNumber),typeof i.leverage=="number"&&q(i.leverage)}catch{}})()},[o,L?.length,a]),s.useEffect(()=>{f.connect();const t=m.toUpperCase();f.subscribe({symbol:t});const d=i=>{if(!i||String(i.symbol||"").toUpperCase()!==t)return;const N=typeof i.bid=="number"?i.bid:typeof i.mid=="number"?i.mid:G,te=typeof i.ask=="number"?i.ask:typeof i.mid=="number"?i.mid:ne;oe(N),le(te)};return f.on("PRICE_UPDATE",d),()=>{f.off("PRICE_UPDATE",d)}},[m]),s.useEffect(()=>{if(u==="limit"){E||I(P);const t=setInterval(()=>{E||I(P)},500);return()=>clearInterval(t)}},[u,P,E]);const he=e.jsxs("div",{className:"space-y-4",children:[y&&e.jsx("div",{className:"bg-red-50 border border-red-300 rounded-lg p-3 text-sm text-red-900 font-medium",role:"alert",children:y}),e.jsxs("div",{children:[e.jsx(z,{className:"text-sm font-medium text-gray-700 mb-2 block",children:"Order Type"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:["market","limit"].map(t=>e.jsx("button",{onClick:()=>K(t),className:`px-4 py-3 rounded-lg font-medium capitalize transition-all ${u===t?"bg-blue-600 text-white shadow-sm":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:t},t))})]}),e.jsxs("div",{children:[e.jsx(z,{className:"text-sm font-medium text-gray-700 mb-2 block",children:"Direction"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("button",{onClick:()=>M("buy"),className:`px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-all ${h==="buy"?"bg-green-600 text-white shadow-sm":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(ie,{className:"w-4 h-4"}),"Buy"]}),e.jsxs("button",{onClick:()=>M("sell"),className:`px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-all ${h==="sell"?"bg-red-600 text-white shadow-sm":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(ce,{className:"w-4 h-4"}),"Sell"]})]})]}),u!=="market"&&e.jsxs("div",{children:[e.jsx(z,{className:"text-sm font-medium text-gray-700 mb-2 block",children:"Entry Price"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{type:"number",value:F??"",onChange:t=>{Q(!0),I(t.target.value?parseFloat(t.target.value):void 0)},placeholder:P.toFixed(5),className:"font-mono text-base h-12"}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Current: ",e.jsx("span",{className:"font-mono font-medium",children:P.toFixed(5)})]})]})]}),e.jsxs("div",{children:[e.jsx(z,{className:"text-sm font-medium text-gray-700 mb-2 block",children:"Volume (Lots)"}),e.jsxs("div",{className:"bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-center gap-4 mb-3",children:[e.jsx("button",{onClick:()=>V(Math.max(.01,parseFloat((b-.01).toFixed(2)))),className:"w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-700 hover:bg-gray-50 active:scale-95 transition-all","aria-label":"Decrease",children:"−"}),e.jsxs("div",{className:"text-center min-w-[100px]",children:[e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:b.toFixed(2)}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Lots"})]}),e.jsx("button",{onClick:()=>V(parseFloat((b+.01).toFixed(2))),className:"w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-700 hover:bg-gray-50 active:scale-95 transition-all","aria-label":"Increase",children:"+"})]}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-sm text-gray-600",children:["≈ ",e.jsx("span",{className:"font-semibold text-gray-900",children:Y(de)})]})})]})]}),e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>D(!p),className:"w-full flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"w-4 h-4 text-gray-600"}),e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["Stop Loss & Take Profit ",(A||T)&&e.jsx("span",{className:"text-green-600",children:"(Set)"})]})]}),e.jsx("span",{className:"text-gray-500",children:p?"▼":"▶"})]}),p&&e.jsxs("div",{className:"grid grid-cols-2 gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx(z,{className:"text-xs font-medium text-gray-600 mb-1 block",children:"Stop Loss"}),e.jsx(se,{type:"number",value:A??"",onChange:t=>Z(t.target.value?parseFloat(t.target.value):void 0),placeholder:"Optional",className:"font-mono text-sm h-10"})]}),e.jsxs("div",{children:[e.jsx(z,{className:"text-xs font-medium text-gray-600 mb-1 block",children:"Take Profit"}),e.jsx(se,{type:"number",value:T??"",onChange:t=>_(t.target.value?parseFloat(t.target.value):void 0),placeholder:"Optional",className:"font-mono text-sm h-10"})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 px-4 py-2 border-b border-gray-200",children:e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Order Summary"})}),e.jsxs("div",{className:"divide-y divide-gray-100",children:[e.jsxs("div",{className:"flex justify-between items-center px-4 py-3",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Leverage"}),e.jsxs("span",{className:"text-sm font-semibold text-gray-900",children:["1:",w]})]}),e.jsxs("div",{className:"flex justify-between items-center px-4 py-3",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Required Margin"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:Y(me)})]}),e.jsxs("div",{className:"flex justify-between items-center px-4 py-3",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Estimated Fee"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:Y(ue)})]}),e.jsxs("div",{className:"flex justify-between items-center px-4 py-3",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Pip Value"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:Y(ve(m,b,P))})]})]})]})]});return e.jsx(je,{open:n,onOpenChange:c,children:e.jsx(we,{fullscreen:!0,className:"p-0 flex flex-col",style:{overflowY:"scroll",maxHeight:"100%"},children:e.jsxs(Ne,{children:[e.jsx("div",{className:"sticky top-0 z-10 bg-white border-b border-gray-200 shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between px-4 py-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs(Se,{className:"text-lg font-semibold text-gray-900",children:[h==="buy"?"Buy":"Sell"," ",m]}),l&&e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:["Account: ",l]})]}),e.jsx("button",{onClick:()=>c(!1),className:"ml-4 p-2 rounded-full hover:bg-gray-100 active:bg-gray-200 transition-colors","aria-label":"Close",children:e.jsx(ke,{className:"w-5 h-5 text-gray-600"})})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto min-h-0 px-4 py-4",children:he}),e.jsx("div",{className:"sticky bottom-0 bg-white border-t border-gray-200 px-4 py-4 shadow-lg",children:e.jsx(re,{onClick:()=>{J("order-confirm"),xe()},disabled:ge,className:`w-full h-12 rounded-lg font-semibold text-white text-base transition-all ${h==="buy"?"bg-green-600 hover:bg-green-700 active:bg-green-800":"bg-red-600 hover:bg-red-700 active:bg-red-800"} disabled:opacity-50 disabled:cursor-not-allowed`,children:x?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsxs("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Processing..."]}):e.jsxs("span",{children:[h==="buy"?"Buy":"Sell"," ",b.toFixed(2)," Lots",u!=="market"&&O?` @ ${O.toFixed(5)}`:""]})})})]})})})}function Le({symbol:n}){const c=s.useRef(null);return s.useEffect(()=>{if(!c.current)return;let m=!1;const v=new ResizeObserver(()=>{});v.observe(c.current);const S=`tv_${n.replace(/[:/]/g,"_")}`;c.current.innerHTML="";const g=document.createElement("div");g.id=S,g.style.width="100%",g.style.height="100%",c.current.appendChild(g);const k=()=>{const a=window.TradingView;m||!a||!g||!c.current||new a.widget({symbol:n,interval:"1",timezone:"Etc/UTC",theme:"light",style:"1",locale:"en",toolbar_bg:"#f8fafc",enable_publishing:!1,allow_symbol_change:!1,hide_side_toolbar:!1,hide_top_toolbar:!1,withdateranges:!0,container_id:S,autosize:!0,width:"100%"})},j=new IntersectionObserver(a=>{if(m)return;const R=a[0];if(R&&R.isIntersecting){if(window.TradingView)k();else{let o=document.getElementById("tradingview-js");o?o.addEventListener("load",k,{once:!0}):(o=document.createElement("script"),o.id="tradingview-js",o.src="https://s3.tradingview.com/tv.js",o.type="text/javascript",o.async=!0,o.onload=()=>k(),document.head.appendChild(o))}j.disconnect()}},{rootMargin:"200px"});if(j.observe(c.current),!window.TradingView){let a=document.getElementById("tradingview-js");a?a.addEventListener("load",()=>{},{once:!0}):(a=document.createElement("script"),a.id="tradingview-js",a.src="https://s3.tradingview.com/tv.js",a.type="text/javascript",a.async=!0,a.onload=()=>{},document.head.appendChild(a))}return()=>{m=!0,v.disconnect(),j.disconnect(),c.current&&(c.current.innerHTML="")}},[n]),e.jsx("div",{ref:c,className:"w-full h-full"})}function De({pair:n,onBack:c,onPlaceOrder:m}){const[v]=s.useState("5m"),[S,g]=s.useState(!1),[k,j]=s.useState("buy"),[a,R]=s.useState(n.bidPrice),[o,L]=s.useState(n.askPrice),[u,K]=s.useState(n.changePercent24h),[h,M]=s.useState(n.bidPrice),[p,D]=s.useState(null),[b,V]=s.useState(n.high24h),[F,I]=s.useState(n.low24h),E=s.useRef(null),[Q,A]=s.useState(56),[Z,T]=s.useState(88),_=s.useRef(null),w=s.useRef(null),[q,U]=s.useState(120);s.useEffect(()=>{},[n.pair]),s.useEffect(()=>{f.connect(),f.subscribe({symbol:n.pair,timeframe:v});const l=r=>{if(r.symbol===n.pair){const x=typeof r.bid=="number"?r.bid:a,B=typeof r.ask=="number"?r.ask:o,y=typeof r.mid=="number"?r.mid:typeof r.bid=="number"&&typeof r.ask=="number"?(r.bid+r.ask)/2:h,X=typeof r.high=="number"?r.high:typeof r.high24h=="number"?r.high24h:b,G=typeof r.low=="number"?r.low:typeof r.low24h=="number"?r.low24h:F;y>h?(D("up"),window.setTimeout(()=>D(null),300)):y<h&&(D("down"),window.setTimeout(()=>D(null),300)),M(y),R(x),L(B),V(X),I(G),typeof r.changePercent=="number"&&K(r.changePercent)}},C=r=>{const x=String(r&&(r.status||r.orderStatus)||"").toLowerCase();x.includes("execut")||x.includes("filled")?J("order-success"):(x.includes("cancel")||x.includes("reject"))&&J("order-error")},H=r=>{const x=!!(r&&(r.success||r.status==="executed"||r.orderStatus==="filled"));J(x?"order-success":"order-error")};return f.on("PRICE_UPDATE",l),f.on("ORDER_UPDATE",C),f.on("order_response",H),()=>{f.unsubscribe({symbols:[n.pair]}),f.off("PRICE_UPDATE",l),f.off("ORDER_UPDATE",C),f.off("order_response",H)}},[n.pair,v]),s.useEffect(()=>{const l=()=>{const y=E.current?.getBoundingClientRect().height||56;A(Math.ceil(y))};l();const C=new ResizeObserver(l);E.current&&C.observe(E.current);const H=()=>{const y=w.current?.getBoundingClientRect().height||120;U(Math.ceil(y))};H();const r=new ResizeObserver(H);w.current&&r.observe(w.current);const x=()=>{const y=_.current?.getBoundingClientRect().height||88;T(Math.ceil(y))};x();const B=new ResizeObserver(x);return _.current&&B.observe(_.current),()=>{C.disconnect(),r.disconnect(),B.disconnect()}},[]);const W=l=>{m({pair:n.pair,type:l.type,direction:l.direction,lotSize:l.lotSize,entryPrice:l.entryPrice,stopLoss:l.stopLoss,takeProfit:l.takeProfit,leverage:l.leverage})};return e.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[e.jsx("div",{ref:E,className:"sticky top-0 z-40",style:{backgroundColor:"#ef5c2a"},children:e.jsxs("div",{className:"flex items-center justify-between px-4 h-14",children:[e.jsx("button",{onClick:c,className:"p-2 -ml-2 hover:bg-white/10 rounded-lg transition-colors","aria-label":"Back",children:e.jsx(Ce,{className:"w-6 h-6 text-white",style:{color:"#fff"}})}),e.jsx("h2",{className:"text-white font-bold",style:{color:"#fff",fontWeight:700},children:n.pair}),e.jsx("div",{className:"w-10"})," "]})}),e.jsx("div",{ref:w,className:"bg-white border-b border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:`text-gray-900 font-mono transition ${p==="up"?"bg-green-50":p==="down"?"bg-red-50":""}`,"aria-live":"polite",children:$(h,n.pair)}),e.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[u>=0?e.jsx(ie,{className:"w-4 h-4 text-green-600"}):e.jsx(ce,{className:"w-4 h-4 text-red-600"}),e.jsxs("span",{className:`${u>=0?"text-green-600":"text-red-600"}`,children:[u>=0?"+":"",u.toFixed(2),"%"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between gap-8 px-3 py-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("p",{className:"text-gray-500",children:"High"}),e.jsx("p",{className:"text-gray-900 font-mono",children:$(b,n.pair)})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("p",{className:"text-gray-500",children:"Low"}),e.jsx("p",{className:"text-gray-900 font-mono",children:$(F,n.pair)})]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-8 px-3 py-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("p",{className:"text-gray-500",children:"Bid"}),e.jsx("p",{className:`text-gray-900 font-mono transition ${p==="up"?"text-green-700":p==="down"?"text-red-700":""}`,children:$(a,n.pair)})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("p",{className:"text-gray-500",children:"Ask"}),e.jsx("p",{className:`text-gray-900 font-mono transition ${p==="up"?"text-green-700":p==="down"?"text-red-700":""}`,children:$(o,n.pair)})]})]})]})]})}),e.jsx("div",{className:"fixed inset-x-0",style:{top:Q+q,bottom:Z,width:"100%"},children:e.jsx("div",{className:"relative w-full h-full overflow-hidden",role:"img","aria-label":`Price chart for ${n.pair}`,style:{touchAction:"none"},children:e.jsx(Le,{symbol:`FX:${n.pair.replace("/","")}`})})}),e.jsx("div",{ref:_,role:"toolbar","aria-label":"Trade actions",className:"fixed bottom-0 left-0 right-0 z-50 bg-white/90 backdrop-blur",style:{padding:"var(--space-section)",paddingBottom:"calc(var(--space-section) + env(safe-area-inset-bottom))"},children:e.jsxs("div",{className:"max-w-md mx-auto grid grid-cols-2",style:{gap:"var(--space-section)"},children:[e.jsx(re,{onClick:()=>{j("buy"),g(!0)},className:"h-12 rounded-[var(--radius-4)] bg-green-600 hover:bg-green-700 text-white",children:"Buy"}),e.jsx(re,{onClick:()=>{j("sell"),g(!0)},className:"h-12 rounded-[var(--radius-4)] bg-red-600 hover:bg-red-700 text-white",children:"Sell"})]})}),e.jsx(Pe,{open:S,onOpenChange:g,symbol:n.pair,bid:n.bidPrice,ask:n.askPrice,initialDirection:k,onConfirm:W})]})}export{De as Trading};
